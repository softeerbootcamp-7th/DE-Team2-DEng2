# [Technical Document] make_silver_stage_1.py

본 문서는 `make_silver_stage_1.py` 스크립트의 데이터 처리 로직 및 실행 방법을 설명합니다. 본 스크립트는 공공데이터(건축물대장, 토지소유, 상권정보)를 결합하여 분석을 위한 Silver Stage 1 데이터셋을 생성합니다.

## 1. 개요 (Overview)
* **목적**: 필지(Lot) 정보를 기반으로 건물 유무, 토지 소유권 정보, 음식점 입점 현황을 통합한 분석 마스터 테이블 생성.
* **주요 기능**:
    * 원천 데이터(Bronze)의 필터링 및 컬럼 정제.
    * 19자리 고유번호(PNU 유사) 생성을 통한 이기종 데이터 조인.
    * 분석 유효성 검증(음식점이 존재하는 본번 그룹만 추출).
    * **Byproduct 생성**: 소유권 변동일자 기준의 부번 리스트 집계. &rarr; 지주와 음식점 대표자가 일치하는지 확인하기 위해 (지주 데이터는 토지대장으로부터 얻어야 하기에, 다른 데이터들처럼 미리 만들어두고 시작할 수 없어서 stage 나눠서 구분)

## 2. 데이터 파이프라인 구조
### 2.1 입력 데이터 (Input)
* **건축물대장 (`buildingLeader`)**: 건축물 용도, 면적, 고유번호 등.
* **토지소유정보 (`tojiSoyuJeongbo`)**: 토지 면적, 소유권 변동일자, 변동 원인 등.
* **음식점정보 (`restaurant`)**: 상호명, 업종 분류, 경위도 좌표 등.

### 2.2 출력 데이터 (Output)
* **Main Data**: 필지별 통합 마스터 정보 (`/main` 경로에 저장).
* **Byproduct**: (법정동명, 본번, 소유권변동일자) 단위의 부번 리스트 집계 테이블 (`/byproduct` 경로에 저장).

## 3. 상세 처리 로직 (Logic Flow)
1. **날짜 자동 계산**: 실행 시점 기준 직전 분기(Quarter)와 해당 분기의 마지막 달을 계산하여 데이터 파티션 경로를 동적으로 설정합니다.
2. **데이터 정제 (Pruning)**:
    * **Building**: 일반건축물(대장구분코드='1')을 추출하며, 지번 정보를 조합해 19자리 고유번호를 생성합니다.
    * **Toji**: 공유인이 없는 단독 소유 데이터를 필터링하며, 동일 고유번호 내에서 최신 소유권 변동 데이터를 추출합니다.
    * **Restaurant**: '음식' 대분류 데이터만 추출하며 위/경도 좌표를 Double 타입으로 정규화합니다.
3. **데이터 조인 (Joining Strategy)**:
    * 토지 데이터를 베이스로 건축물대장을 Left Join합니다.
    * 필지 내 건물 개수가 0개 또는 1개인 경우만 분석 대상으로 선별합니다.
    * 건물이 존재하는 필지에 한해 상권(음식점) 정보를 결합합니다.
4. **최종 클리닝 (Cleaning)**: 본번(Group) 단위로 집계하여, 해당 그룹 내에 음식점이 단 하나도 존재하지 않는 필지들은 분석 가치가 낮은 것으로 판단하여 전체 제외(Anti Join) 처리합니다.
5. **부산물 생성 (Byproduct)**: (법정동명, 본번, 소유권변동일자)가 동일한 레코드들을 그룹화하고, 해당 그룹에 속한 부번들을 리스트(`collect_list`)로 모아 별도 저장합니다.

## 4. 실행 가이드 (Usage)
본 스크립트는 `spark-submit`을 통해 실행하며, 특정 시군구만 처리하거나 해당 지역(Region) 전체를 처리할 수 있도록 설계되었습니다.

### 4.1 전체 지역 실행 (Region 단위)
`--sigungu_code` 인자를 생략하면 입력된 `--region`에 해당하는 전체 데이터를 처리합니다. 결과는 `sigungu=all` 경로에 저장됩니다.

```bash
# 경기도 전체 데이터 처리 예시
docker exec -it spark-master spark-submit \
    /opt/spark/jobs/transform_silver_stage_1.py \
    --region "경기"
```